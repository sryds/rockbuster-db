SELECT
  B.customer_id,
  B.first_name,
  B.last_name,
  E.country,
  D.city,
SUM(A.amount) AS total_amount_paid
FROM
payment AS A
JOIN customer AS B ON A.customer_id = B.customer_id
JOIN address AS C ON B.address_id = C.address_id
JOIN city AS D ON C.city_id = D.city_id
JOIN country AS E ON D.country_id = E.country_id
WHERE
D.city IN (
  SELECT
  D.city
  FROM
  customer AS B
  JOIN address AS C ON B.address_id = C.address_id
  JOIN city AS D ON C.city_id = D.city_id
  JOIN country AS E ON D.country_id = E.country_id
  WHERE
  E.country IN (
    SELECT
    E.country
    FROM
    customer AS B
    JOIN address AS C ON B.address_id = C.address_id
    JOIN city AS D ON C.city_id = D.city_id
    JOIN country AS E ON D.country_id = E.country_id
    GROUP BY
    E.country
    ORDER BY
    COUNT(B.customer_id) DESC
    LIMIT 10
    )
  GROUP BY
  E.country,
  D.city
  ORDER BY
  COUNT(B.customer_id) DESC
  LIMIT 10
  )
GROUP BY
B.customer_id,
B.first_name,
B.last_name,
E.country,
D.city
ORDER BY
SUM(A.amount) DESC
LIMIT 5;
